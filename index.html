<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Roster Calendar Import</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        select:disabled, input:disabled, button:disabled {
            background-color: #e9ecef;
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Master Roster Calendar Import</h1>
                <p class="text-gray-600 mt-2">Import the master roster to your digital calendar.</p>
            </div>

            <form id="rosterForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="sheetName" class="block text-sm font-medium text-gray-700 mb-1">Which roster?</label>
                        <select id="sheetName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" disabled>
                            <option>Loading...</option>
                        </select>
                    </div>
                     <div>
                        <label for="rosterBlocks" class="block text-sm font-medium text-gray-700 mb-1">Roster Blocks</label>
                        <select id="rosterBlocks" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" disabled>
                           <option>Select a roster first</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Roster Start Date</label>
                        <input type="date" id="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" disabled>
                        <p class="text-xs text-gray-500 mt-1">Cannot be earlier than the roster's start.</p>
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Roster End Date</label>
                        <input type="date" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" disabled>
                        <p class="text-xs text-gray-500 mt-1">Adjusts to a full fortnight from the start date.</p>
                    </div>
                </div>
                
                 <div>
                    <label for="startLine" class="block text-sm font-medium text-gray-700 mb-1">Starting Line Number</label>
                    <input type="number" id="startLine" value="3" min="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 3">
                </div>


                <div class="flex flex-col sm:flex-row gap-4 pt-2">
                    <button type="button" id="testRunBtn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200" disabled>
                        Test Run (First Fortnight)
                    </button>
                    <button type="submit" id="generateBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200" disabled>
                        Generate ICS Files
                    </button>
                </div>
            </form>

            <div id="results" class="mt-8 text-left hidden">
                <div id="loader" class="loader mx-auto my-4 hidden"></div>
                <p id="status" class="text-lg font-medium text-center"></p>
                <div id="download-links" class="mt-4 space-y-3"></div>
                <div id="test-run-output" class="mt-6 hidden"></div>
            </div>
        </div>
        <footer class="text-center text-sm text-gray-500 mt-6">
            <p>Created with Gemini</p>
        </footer>
    </div>

    <!-- Sanity Check Modal -->
    <div id="dateSanityCheckModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Incorrect Start Date</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        The selected start date is not the beginning of a fortnight. Please choose one of the correct dates below to continue.
                    </p>
                </div>
                <div class="items-center px-4 py-3 space-y-2">
                    <button id="modalPrevDateBtn" class="w-full px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        <!-- Date will be injected here -->
                    </button>
                    <button id="modalNextDateBtn" class="w-full px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        <!-- Date will be injected here -->
                    </button>
                    <button id="modalCancelBtn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        const AppState = {
            blockDataCache: {},
            rosterDates: [],
            gasUrl: 'https://script.google.com/macros/s/AKfycbxYIvUCKHqVT5ygPoXSi1F1bkvOOg41eaX-2UQq8Pfr9JHrxd7bALo1Vaey9FNrk3Ds/exec'
        };

        document.addEventListener('DOMContentLoaded', () => {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            document.getElementById('sheetName').addEventListener('change', populateBlockDropdown);
            
            const handleStartDateChange = () => {
                adjustStartDate();
                adjustEndDate();
            };
            startDateInput.addEventListener('change', handleStartDateChange);
            startDateInput.addEventListener('blur', handleStartDateChange);

            endDateInput.addEventListener('change', adjustEndDate);
            endDateInput.addEventListener('blur', adjustEndDate);

            document.getElementById('rosterForm').addEventListener('submit', (e) => runProcess(e, false));
            document.getElementById('testRunBtn').addEventListener('click', (e) => runProcess(e, true));

            if (!getCookie('testRunCompleted')) {
                localStorage.removeItem('rosterAppCache');
            }

            initializeFromGasUrl();
        });

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        function parseDMY(dateString) {
            const parts = dateString.match(/(\d+)/g);
            if (!parts || parts.length < 3) return null;
            return new Date(Date.UTC(parts[2], parts[1] - 1, parts[0]));
        }

        function adjustStartDate() {
            const startDateInput = document.getElementById('startDate');
            let start = new Date(startDateInput.value + 'T00:00:00Z');
            const minDate = new Date(startDateInput.min + 'T00:00:00Z');
            const maxDate = startDateInput.max ? new Date(startDateInput.max + 'T00:00:00Z') : null;

            if (isNaN(start.getTime()) || start < minDate) {
                start = minDate;
            }
            
            if (maxDate && start > maxDate) {
                start = maxDate;
            }
            
            startDateInput.value = start.toISOString().split('T')[0];
        }

        function adjustEndDate() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            let start = new Date(startDateInput.value + 'T00:00:00Z');
            let end = new Date(endDateInput.value + 'T00:00:00Z');

            if (isNaN(start.getTime())) return;

            if (isNaN(end.getTime()) || end < start) {
                end = new Date(start);
                end.setUTCDate(start.getUTCDate() + 13);
            }

            const oneDay = 1000 * 60 * 60 * 24;
            const diffDays = Math.round((end - start) / oneDay) + 1;

            const numFortnights = Math.ceil(diffDays / 14);
            const totalDays = numFortnights * 14;

            let newEndDate = new Date(start);
            newEndDate.setUTCDate(start.getUTCDate() + totalDays - 1);

            const maxDateStr = endDateInput.max;
            if (maxDateStr) {
                const maxDate = new Date(maxDateStr + 'T00:00:00Z');
                if (newEndDate > maxDate) {
                    newEndDate = maxDate;
                }
            }

            endDateInput.value = newEndDate.toISOString().split('T')[0];
        }

        async function initializeFromGasUrl() {
            const sheetSelect = document.getElementById('sheetName');
            sheetSelect.innerHTML = '<option>Loading rosters...</option>';
            clearResults();
            
            const cachedData = localStorage.getItem('rosterAppCache');
            if (cachedData) {
                const { sheets, blocks } = JSON.parse(cachedData);
                populateInitialDropdowns(sheets, blocks);
                return;
            }

            const cacheBust = `&_=${new Date().getTime()}`;
            try {
                const [sheetsResponse, blocksResponse] = await Promise.all([
                    fetch(`${AppState.gasUrl}?action=getSheets${cacheBust}`),
                    fetch(`${AppState.gasUrl}?action=getBlocks${cacheBust}`)
                ]);

                const sheetsResult = await sheetsResponse.json();
                if (!sheetsResult.success) throw new Error(sheetsResult.error);
                
                const blocksResult = await blocksResponse.json();
                if (!blocksResult.success) throw new Error(blocksResult.error);
                
                populateInitialDropdowns(sheetsResult.data, blocksResult.data);

            } catch (error) {
                console.error('Initialization Error:', error);
                showError(`Initialization failed: ${error.message}. The script URL may be incorrect or deployment needs to be updated.`);
                sheetSelect.innerHTML = `<option>Error loading rosters</option>`;
            }
        }

        function populateInitialDropdowns(sheetNames, blockData) {
            const sheetSelect = document.getElementById('sheetName');
            AppState.blockDataCache = blockData;
            AppState.rosterDates = sheetNames
                .map(name => parseDMY(name))
                .filter(date => date !== null)
                .sort((a, b) => a - b);
            
            sheetSelect.innerHTML = '<option value="">-- Select a roster --</option>';
            sheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                sheetSelect.appendChild(option);
            });
            sheetSelect.disabled = false;
        }
        
        function updateButtonStates() {
            const generateBtn = document.getElementById('generateBtn');
            const testRunBtn = document.getElementById('testRunBtn');
            const rosterSelected = !!document.getElementById('sheetName').value;
            const blockSelected = !!document.getElementById('rosterBlocks').value;
            const formIsValid = rosterSelected && blockSelected;

            if (formIsValid) {
                testRunBtn.disabled = false;
                if (getCookie('testRunCompleted') === 'true') {
                    generateBtn.disabled = false;
                } else {
                    generateBtn.disabled = true;
                }
            } else {
                testRunBtn.disabled = true;
                generateBtn.disabled = true;
            }
        }

        function populateBlockDropdown() {
            const selectedRoster = document.getElementById('sheetName').value;
            const blockSelect = document.getElementById('rosterBlocks');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            blockSelect.innerHTML = '';
            if (!selectedRoster) {
                blockSelect.innerHTML = '<option>Select a roster first</option>';
                startDateInput.disabled = true;
                endDateInput.disabled = true;
                updateButtonStates();
                return;
            }
            
            const rosterStartDate = parseDMY(selectedRoster);
            if (rosterStartDate) {
                const formattedDate = rosterStartDate.toISOString().split('T')[0];
                startDateInput.value = formattedDate;
                startDateInput.min = formattedDate;
                endDateInput.min = formattedDate;
                startDateInput.disabled = false;
                endDateInput.disabled = false;

                const currentIndex = AppState.rosterDates.findIndex(d => d.getTime() === rosterStartDate.getTime());

                if (currentIndex > -1 && currentIndex < AppState.rosterDates.length - 1) {
                    const nextRosterStartDate = AppState.rosterDates[currentIndex + 1];
                    const maxEndDate = new Date(nextRosterStartDate);
                    maxEndDate.setUTCDate(maxEndDate.getUTCDate() - 1);
                    endDateInput.max = maxEndDate.toISOString().split('T')[0];

                    const latestStartDate = new Date(maxEndDate);
                    latestStartDate.setUTCDate(latestStartDate.getUTCDate() - 13);
                    startDateInput.max = latestStartDate.toISOString().split('T')[0];

                } else {
                    endDateInput.removeAttribute('max');
                    startDateInput.removeAttribute('max');
                }
                
                const defaultEndDate = new Date(rosterStartDate);
                defaultEndDate.setUTCDate(rosterStartDate.getUTCDate() + 13);
                endDateInput.value = defaultEndDate.toISOString().split('T')[0];
                adjustEndDate();
            }

            const blocksForRoster = AppState.blockDataCache[selectedRoster] || [];
            if (blocksForRoster.length > 0) {
                blocksForRoster.forEach(block => {
                    const option = document.createElement('option');
                    option.value = block;
                    option.textContent = block;
                    blockSelect.appendChild(option);
                });
            } else {
                blockSelect.innerHTML = '<option>No blocks found for this roster</option>';
            }
            updateButtonStates();
        }

        function clearResults() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('status').textContent = '';
            document.getElementById('download-links').innerHTML = '';
            document.getElementById('test-run-output').innerHTML = '';
            document.getElementById('test-run-output').classList.add('hidden');
        }

        function prepareForRun(statusMessage) {
            clearResults();
            const resultsDiv = document.getElementById('results');
            const statusP = document.getElementById('status');
            const loader = document.getElementById('loader');
            
            resultsDiv.classList.remove('hidden');
            loader.classList.remove('hidden');
            statusP.textContent = statusMessage;
            statusP.className = 'text-lg font-medium text-center text-gray-700';
        }

        function isValidFortnightStartDate(date) {
            const referenceDate = AppState.rosterDates[0];
            if (!referenceDate) return false; // Cannot validate without a reference

            const oneDay = 1000 * 60 * 60 * 24;
            const diffDays = Math.round((date - referenceDate) / oneDay);

            return diffDays % 14 === 0;
        }

        function runProcess(event, isTestRun) {
            event.preventDefault();
            const startDateInput = document.getElementById('startDate');
            const start = new Date(startDateInput.value + 'T00:00:00Z');

            if (isValidFortnightStartDate(start)) {
                if (isTestRun) {
                    proceedWithTestRun();
                } else {
                    proceedWithFormSubmit();
                }
            } else {
                const oneDay = 1000 * 60 * 60 * 24;
                const referenceDate = AppState.rosterDates[0];
                const diffDays = Math.round((start - referenceDate) / oneDay);
                const remainder = diffDays % 14;

                const prevDate = new Date(start);
                prevDate.setUTCDate(start.getUTCDate() - remainder);

                const nextDate = new Date(start);
                nextDate.setUTCDate(start.getUTCDate() + (14 - remainder));

                const modal = document.getElementById('dateSanityCheckModal');
                const prevBtn = document.getElementById('modalPrevDateBtn');
                const nextBtn = document.getElementById('modalNextDateBtn');
                const cancelBtn = document.getElementById('modalCancelBtn');

                prevBtn.textContent = `Use Previous: ${prevDate.toLocaleDateString()}`;
                nextBtn.textContent = `Use Next: ${nextDate.toLocaleDateString()}`;

                const onPrevClick = () => {
                    startDateInput.value = prevDate.toISOString().split('T')[0];
                    adjustEndDate();
                    if (isTestRun) proceedWithTestRun(); else proceedWithFormSubmit();
                    modal.classList.add('hidden');
                };

                const onNextClick = () => {
                    startDateInput.value = nextDate.toISOString().split('T')[0];
                    adjustEndDate();
                    if (isTestRun) proceedWithTestRun(); else proceedWithFormSubmit();
                    modal.classList.add('hidden');
                };

                const onCancelClick = () => {
                    modal.classList.add('hidden');
                };

                prevBtn.onclick = onPrevClick;
                nextBtn.onclick = onNextClick;
                cancelBtn.onclick = onCancelClick;

                modal.classList.remove('hidden');
            }
        }

        async function proceedWithTestRun() {
            const generateBtn = document.getElementById('generateBtn');
            const testRunBtn = document.getElementById('testRunBtn');
            
            generateBtn.disabled = true;
            testRunBtn.disabled = true;

            try {
                const { sheetData, startDate, startLine, rosterBlocks } = await getAndValidateInputs();
                prepareForRun(`Running test from line ${startLine}...`);
                
                setTimeout(() => {
                    const rosterData = generateRosterData(sheetData, startDate, null, startLine, rosterBlocks, 14);
                    
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('status').textContent = 'Test run complete.';
                    document.getElementById('status').className = 'text-lg font-medium text-center text-green-600';
                    displayTestTable(rosterData);
                    setCookie('testRunCompleted', 'true', 7);
                    
                    const cachePayload = { sheets: AppState.rosterDates.map(d => d.toLocaleDateString('en-GB')), blocks: AppState.blockDataCache };
                    localStorage.setItem('rosterAppCache', JSON.stringify(cachePayload));
                    updateButtonStates();
                }, 50);

            } catch (error) {
                console.error('Error during test run:', error);
                showError(error.message);
                updateButtonStates();
            }
        }

        async function proceedWithFormSubmit() {
            const generateBtn = document.getElementById('generateBtn');
            const testRunBtn = document.getElementById('testRunBtn');
            
            generateBtn.disabled = true;
            testRunBtn.disabled = true;

            try {
                const { sheetData, startDate, endDate, startLine, rosterBlocks } = await getAndValidateInputs();
                prepareForRun(`Generating calendar from line ${startLine}...`);

                setTimeout(() => {
                    const icsData = generateIcsContent(sheetData, startDate, endDate, startLine, rosterBlocks);

                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('status').textContent = 'Successfully generated calendar files!';
                    document.getElementById('status').className = 'text-lg font-medium text-center text-green-600';
                    
                    createDownloadLink('shifts.ics', icsData.shifts, 'Download Shifts Calendar');
                    createDownloadLink('daysoff.ics', icsData.daysOff, 'Download Days Off Calendar');
                    updateButtonStates();
                }, 50);

            } catch (error) {
                console.error('Error during process:', error);
                showError(error.message);
                updateButtonStates();
            }
        }
        
        async function getAndValidateInputs() {
            const sheetName = document.getElementById('sheetName').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const startLine = parseInt(document.getElementById('startLine').value, 10);
            const rosterBlocksStr = document.getElementById('rosterBlocks').value;

            if (!sheetName || !startDate || !endDate || isNaN(startLine) || !rosterBlocksStr) {
                throw new Error('Please fill in all fields.');
            }

            const sheetData = await fetchSheetData(AppState.gasUrl, sheetName);
            const rosterBlocks = parseRosterBlocks(rosterBlocksStr);
            if (rosterBlocks.length === 0) {
                throw new Error('Invalid roster block format. Use format like "3-20".');
            }
            
            return { sheetData, startDate, endDate, startLine, rosterBlocks };
        }

        function showError(message) {
            const statusP = document.getElementById('status');
            document.getElementById('loader').classList.add('hidden');
            statusP.textContent = `Error: ${message}`;
            statusP.className = 'text-lg font-medium text-center text-red-600';
        }

        async function fetchSheetData(gasUrl, sheetName) {
            const cacheBust = `&_=${new Date().getTime()}`;
            const url = `${gasUrl}?action=getSheetData&sheetName=${encodeURIComponent(sheetName)}${cacheBust}`;
            const response = await fetch(url);
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'Failed to fetch data via Apps Script.');
            }
            return result.data || [];
        }

        function parseRosterBlocks(blocksStr) {
            return blocksStr.split(',').map(part => {
                const range = part.trim().split('-');
                if (range.length !== 2) return null;
                const start = parseInt(range[0], 10);
                const end = parseInt(range[1], 10);
                return (!isNaN(start) && !isNaN(end) && start <= end) ? { start, end } : null;
            }).filter(Boolean);
        }

        function generateRosterData(sheetData, startDateStr, endDateStr, startLine, rosterBlocks, numberOfDays = null) {
            const rosterOutput = [];
            let currentDate = new Date(startDateStr + 'T00:00:00Z');
            const finalDate = endDateStr ? new Date(endDateStr + 'T00:00:00Z') : null;
            let currentLine = startLine;

            const dataMap = new Map(sheetData.map(row => [parseInt(row[0], 10), row]).filter(([key]) => !isNaN(key)));

            let dayCounter = 0;
            while (true) {
                if (numberOfDays && dayCounter >= numberOfDays) break;
                if (finalDate && currentDate > finalDate) break;
                if (!numberOfDays && !finalDate && dayCounter >= 365*5) break; 

                if (dayCounter > 0 && dayCounter % 14 === 0) {
                    const currentBlock = rosterBlocks.find(b => currentLine >= b.start && currentLine <= b.end);
                    currentLine++;
                    if (currentBlock && currentLine > currentBlock.end) {
                        currentLine = currentBlock.start;
                    }
                }

                const dayOfWeek = currentDate.getUTCDay();
                const dayInFortnight = dayCounter % 14;
                const columnIndex = dayInFortnight < 7 ? dayOfWeek + 1 : dayOfWeek + 8;
                const rowData = dataMap.get(currentLine);
                const cellContent = (rowData && rowData[columnIndex]) ? String(rowData[columnIndex]).trim() : '';

                let parsedDetails = 'No Data';
                let eventType = null;
                let eventDetails = null;

                if (cellContent.toUpperCase() === 'OFF' || cellContent.toUpperCase() === 'ADO') {
                    parsedDetails = `All-day: ${cellContent}`;
                    eventType = 'dayOff';
                    eventDetails = cellContent;
                } else if (cellContent) {
                    const shiftDetails = parseShiftDetails(cellContent);
                    if (shiftDetails) {
                        parsedDetails = `Shift: ${shiftDetails.summary} (${shiftDetails.start} - ${shiftDetails.end})`;
                        eventType = 'shift';
                        eventDetails = shiftDetails;
                    } else {
                        parsedDetails = `Unrecognized format: "${cellContent}"`;
                    }
                }

                rosterOutput.push({
                    date: new Date(currentDate),
                    rawContent: cellContent || '---',
                    parsed: parsedDetails,
                    eventType,
                    eventDetails,
                    lineNumber: currentLine
                });

                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                dayCounter++;
            }
            return rosterOutput;
        }

        function generateIcsContent(sheetData, startDateStr, endDateStr, startLine, rosterBlocks) {
            const rosterData = generateRosterData(sheetData, startDateStr, endDateStr, startLine, rosterBlocks);
            let shiftEvents = [];
            let daysOffEvents = [];

            rosterData.forEach(day => {
                if (day.eventType === 'shift') {
                    shiftEvents.push(createIcsEvent(day.date, day.eventDetails, false));
                } else if (day.eventType === 'dayOff') {
                    daysOffEvents.push(createIcsEvent(day.date, day.eventDetails, true));
                }
            });

            return {
                shifts: createIcsFile(shiftEvents),
                daysOff: createIcsFile(daysOffEvents)
            };
        }

        function displayTestTable(data) {
            const container = document.getElementById('test-run-output');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let tableHTML = `<h3 class="text-xl font-semibold mb-4 text-left">Test Run Results (First Fortnight)</h3>`;

            for (let week = 0; week < 2; week++) {
                const weekData = data.slice(week * 7, (week + 1) * 7);
                if (weekData.length === 0) continue;

                tableHTML += `<div class="overflow-x-auto rounded-lg border border-gray-200 ${week > 0 ? 'mt-4' : ''}">
                    <table class="min-w-full table-fixed">
                        <thead class="bg-gray-50">
                            <tr>`;
                days.forEach(day => {
                    tableHTML += `<th class="px-2 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider text-center">${day}</th>`;
                });
                tableHTML += `</tr>
                        </thead>
                        <tbody class="bg-white divide-x divide-gray-200">
                            <tr>`;
                weekData.forEach(day => {
                    const date = day.date.getUTCDate();
                    let content = '';
                    let bgColor = 'bg-white';

                    if (day.eventType === 'shift') {
                        const details = day.eventDetails;
                        content = `<div class="font-semibold text-gray-800">${details.start} - ${details.end}</div>
                                   <div class="mt-1 text-gray-600">${details.summary}</div>`;
                        bgColor = 'bg-green-50';
                    } else if (day.eventType === 'dayOff') {
                        content = `<span class="font-bold text-blue-600">${day.eventDetails}</span>`;
                        bgColor = 'bg-blue-50';
                    } else {
                        content = '<span class="text-gray-400">---</span>';
                        bgColor = 'bg-gray-50';
                    }

                    tableHTML += `<td class="h-32 align-top p-2 ${bgColor}">
                                    <div class="flex justify-between items-baseline">
                                        <div class="font-bold text-gray-900">${date}</div>
                                        <div class="text-xs text-gray-400 font-mono">L${day.lineNumber}</div>
                                    </div>
                                    <div class="text-xs mt-1 break-words">${content}</div>
                                  </td>`;
                });
                tableHTML += `</tr>
                        </tbody>
                    </table>
                </div>`;
            }

            container.innerHTML = tableHTML;
            container.classList.remove('hidden');
        }

        function parseShiftDetails(content) {
            const regex = /^(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})\s+([\d]+(?:\(i\))?)/;
            const match = content.match(regex);
            if (!match) return null;
            
            const [, startTime, endTime, summary] = match;
            return { start: startTime, end: endTime, summary: summary.trim() };
        }

        function createIcsEvent(date, details, isAllDay) {
            const uid = `${date.toISOString().slice(0,10)}-${Math.random().toString(36).substr(2, 9)}@roster.app`;
            const dtstamp = new Date().toISOString().replace(/[-:.]/g, '').slice(0, 15) + 'Z';
            let eventString = 'BEGIN:VEVENT\n';
            eventString += `UID:${uid}\n`;
            eventString += `DTSTAMP:${dtstamp}\n`;

            if (isAllDay) {
                const yyyy = date.getUTCFullYear();
                const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
                const dd = String(date.getUTCDate()).padStart(2, '0');
                eventString += `DTSTART;VALUE=DATE:${yyyy}${mm}${dd}\n`;
                eventString += `SUMMARY:${details}\n`;
            } else {
                const startDate = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), ...details.start.split(':')));
                const endDate = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), ...details.end.split(':')));
                
                if (endDate < startDate) endDate.setUTCDate(endDate.getUTCDate() + 1);

                const formatIcsDate = (d) => d.toISOString().replace(/[-:.]/g, '').slice(0, 15);
                
                eventString += `DTSTART:${formatIcsDate(startDate)}\n`;
                eventString += `DTEND:${formatIcsDate(endDate)}\n`;
                eventString += `SUMMARY:${details.summary}\n`;
            }
            eventString += 'END:VEVENT\n';
            return eventString;
        }

        function createIcsFile(events) {
            return `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Gemini//RosterApp//EN\n${events.join('')}END:VCALENDAR`;
        }

        function createDownloadLink(filename, content, linkText) {
            const downloadLinksDiv = document.getElementById('download-links');
            const blob = new Blob([content], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.textContent = linkText;
            a.className = 'block w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-200 text-center';
            downloadLinksDiv.appendChild(a);
        }
    </script>
</body>
</html>
