<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS Download Test (w/ Confirmation)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white p-8 rounded-lg shadow-md max-w-md w-full text-center">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">iOS Download Test (w/ Confirmation)</h1>
        <p class="text-gray-600 mb-6">
            This version includes a re-download confirmation on the second tap.
        </p>

        <div id="link-container" class="flex flex-col sm:flex-row gap-4 justify-center"></div>
    </div>

    <!-- Re-download Confirmation Modal -->
    <div id="reDownloadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <div class="text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Re-download File?</h3>
                <div class="mt-2 px-7 py-3"><p class="text-sm text-gray-500">Do you want to download this file again?</p></div>
                <div class="items-center px-4 py-3 flex justify-center gap-4">
                    <button id="reDownloadConfirmBtn" class="px-6 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700">Yes</button>
                    <button id="reDownloadCancelBtn" class="px-6 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">No</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // Helper function to format a Date object into UTC time (YYYYMMDDTHHMMSSZ)
            const toIcsUtcDate = (date) => {
                return date.getUTCFullYear() +
                    ('0' + (date.getUTCMonth() + 1)).slice(-2) +
                    ('0' + date.getUTCDate()).slice(-2) +
                    'T' +
                    ('0' + date.getUTCHours()).slice(-2) +
                    ('0' + date.getUTCMinutes()).slice(-2) +
                    ('0' + date.getUTCSeconds()).slice(-2) +
                    'Z';
            };

            // Helper function to format a Date object into FLOATING time (YYYYMMDDTHHMMSS)
            const toIcsFloatingDate = (date) => {
                return date.getFullYear() +
                    ('0' + (date.getMonth() + 1)).slice(-2) +
                    ('0' + date.getDate()).slice(-2) +
                    'T' +
                    ('0' + date.getHours()).slice(-2) +
                    ('0' + date.getMinutes()).slice(-2) +
                    ('0' + date.getSeconds()).slice(-2);
            };

            // Define event data with a 'type' property
            const eventData = [
                { uid: 'work-shift-1@example.com', type: 'Work Shift', start: new Date('2025-09-05T09:00:00'), end: new Date('2025-09-05T17:00:00'), summary: 'Morning Shift', description: 'Standard work shift.', location: 'Leumeah, NSW, Australia' },
                { uid: 'appointment-1@example.com', type: 'Appointment', start: new Date('2025-09-06T14:00:00'), end: new Date('2025-09-06T15:30:00'), summary: 'Dentist Appointment', description: 'Annual check-up.', location: 'Campbelltown, NSW, Australia' }
            ];

            const generateIcsContent = (events) => {
                const now = new Date();
                let icsLines = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//Test//MyWebApp//EN'];
                events.forEach(event => {
                    icsLines.push('BEGIN:VEVENT', `UID:${event.uid}`, `DTSTAMP:${toIcsUtcDate(now)}`, `DTSTART:${toIcsFloatingDate(event.start)}`, `DTEND:${toIcsFloatingDate(event.end)}`, `SUMMARY:${event.summary}`, `DESCRIPTION:${event.description}`, `LOCATION:${event.location}`, 'END:VEVENT');
                });
                icsLines.push('END:VCALENDAR');
                return icsLines.join('\r\n');
            };
            
            const createDownloadLink = (filename, linkText, icsContent) => {
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.textContent = linkText;
                a.download = filename;
                a.className = 'inline-block bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors';
                
                a.addEventListener('click', (e) => {
                    if (a.dataset.clicked === 'true') {
                        e.preventDefault();
                        const modal = document.getElementById('reDownloadModal');
                        modal.classList.remove('hidden');

                        const confirmBtn = document.getElementById('reDownloadConfirmBtn');
                        const cancelBtn = document.getElementById('reDownloadCancelBtn');

                        const newConfirmBtn = confirmBtn.cloneNode(true);
                        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

                        newConfirmBtn.onclick = () => {
                            // Create a fresh blob and URL to avoid Safari issues
                            const freshBlob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                            const freshUrl = URL.createObjectURL(freshBlob);
                            
                            // Use window.location to trigger import on iOS
                            window.location.href = freshUrl;
                            
                            // No need for a temporary link here
                            setTimeout(() => URL.revokeObjectURL(freshUrl), 200);
                            
                            modal.classList.add('hidden');
                        };

                        cancelBtn.onclick = () => {
                            modal.classList.add('hidden');
                        };
                    } else {
                        a.dataset.clicked = 'true';
                        a.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        a.classList.add('bg-gray-400');
                        // Do NOT revoke the URL on a short timer. Let it live until the user leaves the page.
                    }
                });

                document.getElementById('link-container').appendChild(a);
            };

            const categories = [...new Set(eventData.map(event => event.type))];
            categories.forEach(category => {
                const filteredEvents = eventData.filter(event => event.type === category);
                if (filteredEvents.length > 0) {
                    const icsContent = generateIcsContent(filteredEvents);
                    const filename = `${category.toLowerCase().replace(/\s+/g, '-')}.ics`;
                    const linkText = `Import ${category}s`;
                    createDownloadLink(filename, linkText, icsContent);
                }
            });
        });
    </script>
</body>
</html>

