<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Roster Calendar Import</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        select:disabled, input:disabled, button:disabled {
            background-color: #e9ecef;
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Master Roster Calendar Import</h1>
                <p class="text-gray-600 mt-2">Import the master roster to your digital calendar.</p>
            </div>

            <form id="rosterForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="sheetName" class="block text-sm font-medium text-gray-700 mb-1">Which roster?</label>
                        <select id="sheetName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" disabled>
                            <option>Loading...</option>
                        </select>
                    </div>
                     <div>
                        <label for="startLine" class="block text-sm font-medium text-gray-700 mb-1">Starting Line Number</label>
                        <input type="number" id="startLine" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 3" disabled>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Roster Start Date</label>
                        <input type="date" id="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" disabled>
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Roster End Date</label>
                        <input type="date" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" disabled>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 pt-2">
                    <button type="submit" id="generateBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200" disabled>
                        Generate ICS Files
                    </button>
                </div>
            </form>

            <div id="results" class="mt-8 text-left hidden">
                <div id="loader" class="loader mx-auto my-4 hidden"></div>
                <p id="status" class="text-lg font-medium text-center"></p>
                <div id="download-links" class="mt-4 space-y-3"></div>
            </div>
        </div>
        <footer class="text-center text-sm text-gray-500 mt-6">
            <p>Created by Jarryd Pearson.</p>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gasUrl = 'https://script.google.com/macros/s/AKfycbxYIvUCKHqVT5ygPoXSi1F1bkvOOg41eaX-2UQq8Pfr9JHrxd7bALo1Vaey9FNrk3Ds/exec';
            const sheetSelect = document.getElementById('sheetName');
            const startLineInput = document.getElementById('startLine');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const generateBtn = document.getElementById('generateBtn');
            let rosterDates = [];

            async function initialize() {
                sheetSelect.innerHTML = '<option>Loading rosters...</option>';
                try {
                    const response = await fetch(`${gasUrl}?action=getSheets`);
                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);

                    rosterDates = result.data
                        .map(name => parseDMY(name))
                        .filter(date => date !== null)
                        .sort((a, b) => a - b);

                    sheetSelect.innerHTML = '<option value="">-- Select a roster --</option>';
                    result.data.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        sheetSelect.appendChild(option);
                    });
                    sheetSelect.disabled = false;
                } catch (error) {
                    console.error('Initialization Error:', error);
                    sheetSelect.innerHTML = `<option>Error loading rosters</option>`;
                }
            }
            
            function parseDMY(dateString) {
                const parts = dateString.match(/(\d+)/g);
                if (!parts || parts.length < 3) return null;
                // Use new Date(YYYY, MM-1, DD) for local time, not UTC
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }

            sheetSelect.addEventListener('change', () => {
                const selectedRoster = sheetSelect.value;
                if (!selectedRoster) {
                    [startLineInput, startDateInput, endDateInput, generateBtn].forEach(el => el.disabled = true);
                    return;
                }
                
                const rosterStartDate = parseDMY(selectedRoster);
                if (rosterStartDate) {
                    const formattedDate = toInputDateString(rosterStartDate);
                    startDateInput.value = formattedDate;
                    
                    const defaultEndDate = new Date(rosterStartDate);
                    defaultEndDate.setDate(rosterStartDate.getDate() + 13);
                    endDateInput.value = toInputDateString(defaultEndDate);
                }
                
                [startLineInput, startDateInput, endDateInput, generateBtn].forEach(el => el.disabled = false);
            });

            document.getElementById('rosterForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await processRoster();
            });

            async function processRoster() {
                const sheetName = sheetSelect.value;
                const startLine = parseInt(startLineInput.value, 10);
                const startDate = new Date(startDateInput.value); // Reads as local time
                const endDate = new Date(endDateInput.value); // Reads as local time

                if (!sheetName || isNaN(startLine)) {
                    alert('Please select a roster and enter a valid starting line number.');
                    return;
                }

                prepareForRun(`Generating calendar from line ${startLine}...`);

                try {
                    const sheetData = await fetchSheetData(gasUrl, sheetName);
                    
                    const { shiftEvents, dayOffEvents } = parseRosterData(sheetData, startDate, endDate, startLine);

                    document.getElementById('loader').classList.add('hidden');

                    if (shiftEvents.length === 0 && dayOffEvents.length === 0) {
                        showStatus('No valid shifts or days off found to generate.', 'yellow');
                        return;
                    }
                    
                    showStatus('Successfully generated calendar files!', 'green');

                    if (shiftEvents.length > 0) {
                        const icsContent = generateIcsContent(shiftEvents, false);
                        createDownloadLink('shifts.ics', 'Download Shifts', icsContent);
                    }
                    if (dayOffEvents.length > 0) {
                        const icsContent = generateIcsContent(dayOffEvents, true);
                        createDownloadLink('daysoff.ics', 'Download Days Off', icsContent);
                    }
                } catch (error) {
                    console.error('Error during process:', error);
                    showError(error.message);
                }
            }

            function parseRosterData(sheetData, rosterStartDate, rosterEndDate, startLine) {
                 const shiftEvents = [];
                 const dayOffEvents = [];
                 const dataMap = new Map(sheetData.map(row => [parseInt(row[0], 10), row]).filter(([key]) => !isNaN(key)));

                 let currentLine = startLine;
                 let dayCounter = 0;

                 // Assuming the roster block logic is simplified to just incrementing line number every 14 days
                 for (let d = new Date(rosterStartDate); d <= rosterEndDate; d.setDate(d.getDate() + 1)) {
                     
                     if (dayCounter > 0 && dayCounter % 14 === 0) {
                         currentLine++; // Simplified logic
                     }

                     const rowData = dataMap.get(currentLine);
                     const dayInFortnight = dayCounter % 14;
                     const columnIndex = dayInFortnight + 1;
                     const cellContent = (rowData && rowData[columnIndex]) ? String(rowData[columnIndex]).trim() : '';
                     
                     const shiftMatch = parseShiftDetails(cellContent);
                     const eventDate = new Date(d); // Important: Use the loop date

                     if (shiftMatch) {
                        const startTime = shiftMatch.startTime;
                        const endTime = shiftMatch.endTime;

                        const eventStartDate = new Date(eventDate);
                        eventStartDate.setHours(...startTime.split(':'), 0, 0);
                        const eventEndDate = new Date(eventDate);
                        eventEndDate.setHours(...endTime.split(':'), 0, 0);

                        if (eventEndDate < eventStartDate) {
                            eventEndDate.setDate(eventEndDate.getDate() + 1);
                        }

                        shiftEvents.push({
                            uid: `shift-${currentLine}-${dayCounter}@example.com`,
                            start: eventStartDate,
                            end: eventEndDate,
                            summary: shiftMatch.summary,
                            description: shiftMatch.description
                        });

                     } else if (cellContent.toUpperCase() === 'OFF' || cellContent.toUpperCase() === 'ADO') {
                         dayOffEvents.push({
                            uid: `dayoff-${currentLine}-${dayCounter}@example.com`,
                            start: eventDate,
                            summary: cellContent.toUpperCase()
                         });
                     }
                     dayCounter++;
                 }
                 return { shiftEvents, dayOffEvents };
            }

            // --- Helper Functions (Adapted from test.html) ---

            const toIcsUtcDate = (date) => date.toISOString().replace(/[-:.]/g, '').slice(0, 15) + 'Z';
            
            const toIcsFloatingDate = (date) => {
                const year = date.getFullYear();
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const day = ('0' + date.getDate()).slice(-2);
                const hours = ('0' + date.getHours()).slice(-2);
                const minutes = ('0' + date.getMinutes()).slice(-2);
                const seconds = ('0' + date.getSeconds()).slice(-2);
                return `${year}${month}${day}T${hours}${minutes}${seconds}`;
            };

            const toIcsAllDayDate = (date) => {
                const year = date.getFullYear();
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const day = ('0' + date.getDate()).slice(-2);
                return `${year}${month}${day}`;
            };

            const toInputDateString = (date) => {
                const year = date.getFullYear();
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const day = ('0' + date.getDate()).slice(-2);
                return `${year}-${month}-${day}`;
            }
            
            function parseShiftDetails(content) {
                const regex = /^(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})(?:\s+(.+))?/;
                const match = content.match(regex);
                if (!match) return null;

                const startTime = match[1];
                const endTime = match[2];
                const rawDetails = match[3] ? match[3].trim() : '';

                let summary = 'Shift';
                let description = '';

                // This robust parsing is from test.html
                const fxxRegex = /\s*F\d{1,2}$/;
                let detailsToProcess = rawDetails.replace(fxxRegex, '').trim();

                const fourDigitRegex = /^\d{4}/;
                if (detailsToProcess.match(fourDigitRegex)) {
                    const firstSpaceIndex = detailsToProcess.indexOf(' ');
                    if (firstSpaceIndex !== -1) {
                        summary = detailsToProcess.substring(0, firstSpaceIndex).trim();
                        description = detailsToProcess.substring(firstSpaceIndex + 1).trim();
                    } else {
                        summary = detailsToProcess;
                    }
                } else {
                    summary = detailsToProcess;
                }

                if (!summary) summary = 'Shift';
                
                return { startTime, endTime, summary, description };
            }

            function generateIcsContent(events, isAllDay = false) {
                const now = new Date();
                let icsLines = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//Gemini//RosterApp//EN'];
                events.forEach(event => {
                    icsLines.push('BEGIN:VEVENT', `UID:${event.uid}`, `DTSTAMP:${toIcsUtcDate(now)}`);
                    if (isAllDay) {
                        icsLines.push(`DTSTART;VALUE=DATE:${toIcsAllDayDate(event.start)}`);
                    } else {
                        icsLines.push(`DTSTART:${toIcsFloatingDate(event.start)}`, `DTEND:${toIcsFloatingDate(event.end)}`);
                    }
                    icsLines.push(`SUMMARY:${event.summary}`);
                    if (event.description) {
                        icsLines.push(`DESCRIPTION:${event.description}`);
                    }
                    icsLines.push('END:VEVENT');
                });
                icsLines.push('END:VCALENDAR');
                return icsLines.join('\r\n');
            };
            
            function createDownloadLink(filename, linkText, icsContent) {
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.textContent = linkText;
                a.download = filename;
                a.className = 'block w-full bg-green-200 text-green-800 font-semibold py-2 px-4 rounded-lg hover:bg-green-300 transition-colors duration-200 text-center';
                
                document.getElementById('download-links').appendChild(a);

                // Revoke the object URL after a short delay to allow the download to start
                 a.addEventListener('click', () => {
                    setTimeout(() => { URL.revokeObjectURL(url) }, 150);
                }, { once: true });
            };
            
            async function fetchSheetData(gasUrl, sheetName) {
                const url = `${gasUrl}?action=getSheetData&sheetName=${encodeURIComponent(sheetName)}`;
                const response = await fetch(url);
                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'Failed to fetch data.');
                return result.data || [];
            }

            function prepareForRun(message) {
                const resultsDiv = document.getElementById('results');
                const statusP = document.getElementById('status');
                const loader = document.getElementById('loader');
                
                resultsDiv.classList.remove('hidden');
                loader.classList.remove('hidden');
                document.getElementById('download-links').innerHTML = '';
                statusP.textContent = message;
                statusP.className = 'text-lg font-medium text-center text-gray-700';
            }

            function showStatus(message, color) {
                const statusP = document.getElementById('status');
                statusP.textContent = message;
                const colorClasses = {
                    green: 'text-green-600',
                    yellow: 'text-yellow-600',
                    red: 'text-red-600'
                };
                statusP.className = `text-lg font-medium text-center ${colorClasses[color] || 'text-gray-700'}`;
            }

            function showError(message) {
                document.getElementById('loader').classList.add('hidden');
                showStatus(`Error: ${message}`, 'red');
            }

            initialize();
        });
    </script>
</body>
</html>

